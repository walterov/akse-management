# Management of Kubernetes Clusters using Azure DevOps and AKS Engine on Azure Stack Hub

Dependencies
- Github repository with your yaml pipelines and scripts, clone this repo as example
- Azure DevOps Linux Agent VM with access to target Azure Stack Hub stamps
- All scripts in the scripts directory need to have execute permissions
- Deploy a VM with access to the target Azure Stack Hub environment

## Install DevOps Pipeline Agent in a Linux VM
Follow intructions here: https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops

### Summary steps to install and configure the DevOps Agent
The following steps are not intended to substitute the instructions provided in the link above. If you are already familirized with Azure DevOps and have installed agents before, The following instructions should serve as a quick refresher:

0. Create the Agent Pool in the Project Settings in Azure DevOps portal (example: stampregion-akse)
1. Get a Personal Access Token (PAT) from the Azure DevOps portal
2. Get the agent download URL from the Azure DevOps portal
3. Get the Azure Pipeline server URL from the Azure DevOps portal (https://dev.azure.com/<your org>/)
3. Connect to the VM, create "myagent" directory and install the Agent in the VM by downloading and expanding the tar file
4. Run sudo ./bin/installdependencies.sh to install any missing dependencies
5. Run ./config.sh and provide the server URL, PAT, Agent pool created above, default agent name, default work folder (_work)
6. Start the agent by running run.sh

## Steps to create a pipeline
Follow the instructions here: https://docs.microsoft.com/en-us/azure/devops/pipelines/create-first-pipeline?view=azure-devops&tabs=java%2Cyaml%2Cbrowser%2Ctfs-2018-2

0. Clone this repo, save it in your own Github repository
1. When creating the pipeline with the Azure DevOps portal select the GitHub option as the place where your code is
2. Select your repository and select "Existing Azure Pipelines YAML file"
3. Select the "/.pipelines/akse-deploy.yml" as the first pipeline to create
4. Create the variables documented below for the "akse-deploy.yml" pipeline
5. Save it. You are ready to change the variable values and run the pipeline in your Azure Stack Hub stamp

## Variables to define for each pipeline in the repo

### akse-deploy.yml
- Agent.Name: Name of the registered Azure DevOps Agent to be used to run the pipeline.
- AZS_IDENTITY_PROVIDER: Leave blank if you are using AAD, otherwise enter "adfs".
- AZS_PORTAL_URL: URL of the Azure Stack Hub portal.
- AZURE_CLIENT_ID: Service Principal with access to the Azure Stack Hub subscription below.
- AZURE_CLIENT_SECRET: Secret for the Service Principal
- AZURE_LOCATION: Azure Stack Hub location (found within the portal URL)
- AZURE_SUBSCRIPTION_ID: Azure Stack Hub location where the cluster will be created
- CLUSTER_DEFINITION: API model file. The value should be "./kubernetes-azurestack.json"
- DNS_PREFIX: Prefix to be used as part of the FQDN for the master name. Also used in the name for the resource group and output directory generated by aks-engine.
- HYPERKUBE_REPOSITORY: repository for the hypercube. Value should be: "mcr.microsoft.com/k8s/azurestack/core/"
- KUBERNETES_SEM_VERSION: Kubernetes version supported by your aks-engine version. Run aks-engine get-versions to see which versions are available. Example 1.14.
- LINUX_POOL_COUNT: Number of agent nodes
- LINUX_POOL_DISTRO: VM distribution to use. Value should be "aks-ubuntu-16.04".
- LINUX_POOL_VMSIZE: VM size for the agent nodes. Example: "Standard_D2_v2".
- MASTER_POOL_COUNT: Number of master nodes
- MASTER_POOL_DISTRO: VM distribution to use. Value should be "aks-ubuntu-16.04".
- MASTER_POOL_VMSIZE: VM size for the master nodes. Example: "Standard_D2_v2".
- MONITORING_AZURE: TRUE/FALSE if Azure Monitor for Containers will be configured
- MONITORING_PROMETHEUS: TRUE/FALSE if Prometheous and Grafana will be configured
- NETWORK_PLUGIN: Value should be "kubenet".
- NETWORK_POLICY: Not used yet. Leave blank. 
- REPO_ROOT: root directory of the repo "~/akse-management"
- SSH_PUBLIC_KEY: SSH public key to use to access each VM in the cluster
- WORKSPACE_GUID_B64: Azure Monitoring Workspace GUID
- WORKSPACE_KEY_B64: Azure Monitoring Key, base 64 encoded
